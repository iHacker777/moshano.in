#dashboard/index.html
import React, { useEffect, useMemo, useState } from "react";

// --- Simple router ---
function useHashRoute() {
  const [route, setRoute] = useState(() => location.hash.slice(1) || "/login");
  useEffect(() => {
    const onHash = () => setRoute(location.hash.slice(1) || "/login");
    window.addEventListener("hashchange", onHash);
    return () => window.removeEventListener("hashchange", onHash);
  }, []);
  const push = (path) => (location.hash = path);
  return { route, push };
}

// --- API helper ---
const API_BASE = "https://moshano-api.shanoof.workers.dev"; // change if backend served elsewhere

function apiFetch(path, opts = {}) {
  const token = localStorage.getItem("moshano_token");
  const headers = {
    "Content-Type": "application/json",
    ...(token ? { Authorization: `Bearer ${token}` } : {}),
    ...(opts.headers || {}),
  };
  return fetch(`${API_BASE}${path}`,(opts.method ? opts : { ...opts, method: opts.method || "GET" , headers}))
    .then(async (r) => {
      if (!r.ok) throw new Error((await r.text()) || r.statusText);
      const ct = r.headers.get("content-type") || "";
      return ct.includes("application/json") ? r.json() : r.text();
    });
}

// --- UI Primitives (Tailwind) ---
const Shell = ({ user, onLogout, children }) => (
  <div className="min-h-screen bg-neutral-950 text-neutral-100">
    <header className="border-b border-white/10 sticky top-0 backdrop-blur bg-black/40 z-40">
      <div className="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <img src="/assets/img/logo.png" alt="Moshano" className="w-7 h-7 rounded" />
          <span className="font-semibold tracking-tight">Moshano Admin</span>
          <nav className="ml-6 hidden sm:flex items-center gap-1 text-sm">
            <a href="#/dashboard" className="px-2 py-1 rounded hover:bg-white/5">Dashboard</a>
            <a href="#/transactions" className="px-2 py-1 rounded hover:bg-white/5">Transactions</a>
          </nav>
        </div>
        <div className="flex items-center gap-3 text-sm">
          <span className="text-neutral-400">Signed in as</span>
          <span className="font-medium">{user?.name || "—"}</span>
          <button onClick={onLogout} className="px-2 py-1 rounded bg-white/10 hover:bg-white/15">Logout</button>
        </div>
      </div>
    </header>
    <main className="max-w-6xl mx-auto px-4 py-6">{children}</main>
    <footer className="border-t border-white/10 text-xs text-neutral-400">
      <div className="max-w-6xl mx-auto px-4 py-4">© {new Date().getFullYear()} moshano technologies</div>
    </footer>
  </div>
);

const Stat = ({ label, value, hint }) => (
  <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
    <div className="text-xs uppercase tracking-wider text-neutral-400">{label}</div>
    <div className="text-2xl font-semibold mt-1">{value}</div>
    {hint && <div className="text-xs text-neutral-500 mt-1">{hint}</div>}
  </div>
);

// --- Pages ---
function LoginPage({ onLogin }) {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState("");

  async function submit(e){
    e.preventDefault();
    setErr("");
    setLoading(true);
    try{
      const { token, user } = await apiFetch("/login", { method: "POST", body: JSON.stringify({ email, password }) });
      localStorage.setItem("moshano_token", token);
      onLogin(user);
      location.hash = "/dashboard";
    }catch(e){ setErr(e.message || "Login failed"); }
    finally{ setLoading(false); }
  }

  return (
    <div className="min-h-screen grid place-items-center bg-neutral-950 text-neutral-100 px-4">
      <div className="w-full max-w-md border border-white/10 rounded-3xl p-6 bg-white/5 backdrop-blur">
        <div className="flex items-center gap-3 mb-4">
          <img src="/assets/img/logo.png" alt="Moshano" className="w-8 h-8" />
          <h1 className="text-xl font-semibold">Moshano Admin</h1>
        </div>
        <p className="text-sm text-neutral-400 mb-4">Sign in to manage payments.</p>
        <form onSubmit={submit} className="space-y-3">
          <div>
            <label className="block text-sm mb-1">Email</label>
            <input required type="email" value={email} onChange={(e)=>setEmail(e.target.value)}
                   className="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-white/20"/>
          </div>
          <div>
            <label className="block text-sm mb-1">Password</label>
            <input required type="password" value={password} onChange={(e)=>setPassword(e.target.value)}
                   className="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-white/20"/>
          </div>
          {err && <div className="text-red-400 text-sm">{err}</div>}
          <button disabled={loading} className="w-full py-2 rounded-xl bg-gradient-to-r from-cyan-400 to-fuchsia-500 font-semibold disabled:opacity-60">
            {loading ? "Signing in…" : "Sign in"}
          </button>
        </form>
      </div>
    </div>
  );
}

function DashboardHome() {
  const [stats, setStats] = useState({ total: 0, approved: 0, pending: 0, declined: 0 });
  useEffect(() => { apiFetch("/stats").then(setStats).catch(()=>{}); }, []);
  return (
    <div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <Stat label="Total Txns" value={stats.total} />
      <Stat label="Approved" value={stats.approved} />
      <Stat label="Pending" value={stats.pending} />
      <Stat label="Declined" value={stats.declined} />
    </div>
  );
}

function TransactionsPage(){
  const [items, setItems] = useState([]);
  const [page, setPage] = useState(0); // 0-indexed pages of 50
  const [auto, setAuto] = useState(true);
  const [hideEmptyUtr, setHideEmptyUtr] = useState(false);
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState("");

  const limit = 50;
  const offset = page * limit;

  const load = async () => {
    setLoading(true); setErr("");
    try{
      const q = new URLSearchParams({ limit: String(limit), offset: String(offset), hideEmptyUtr: String(hideEmptyUtr) });
      const res = await apiFetch(`/transactions?${q.toString()}`);
      setItems(res.rows || []);
    }catch(e){ setErr(e.message || "Failed to load"); }
    finally{ setLoading(false); }
  };

  useEffect(() => { load(); }, [page, hideEmptyUtr]);

  useEffect(() => {
    if (!auto) return;
    const id = setInterval(load, 30_000);
    return () => clearInterval(id);
  }, [auto, page, hideEmptyUtr]);

  async function act(id, action){
    const ok = confirm(`Are you sure you want to ${action} txn ${id}?`);
    if (!ok) return;
    try{
      await apiFetch(`/transactions/${id}/${action}`, { method: "POST" });
      await load();
    }catch(e){ alert(e.message || "Action failed"); }
  }

  return (
    <div className="space-y-3">
      <div className="flex flex-wrap items-center justify-between gap-3">
        <div className="flex items-center gap-3">
          <label className="flex items-center gap-2 text-sm">
            <input type="checkbox" checked={auto} onChange={(e)=>setAuto(e.target.checked)} />
            Auto-refresh (30s)
          </label>
          <label className="flex items-center gap-2 text-sm">
            <input type="checkbox" checked={hideEmptyUtr} onChange={(e)=>setHideEmptyUtr(e.target.checked)} />
            Hide Empty UTR
          </label>
        </div>
        <div className="flex items-center gap-2">
          <button onClick={load} className="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/15 text-sm">Refresh</button>
          <div className="text-sm text-neutral-400">Page {page+1}</div>
          <button onClick={()=>setPage((p)=>Math.max(0,p-1))} className="px-2 py-1.5 rounded-lg bg-white/10 disabled:opacity-50" disabled={page===0}>&lt;</button>
          <button onClick={()=>setPage((p)=>p+1)} className="px-2 py-1.5 rounded-lg bg-white/10">&gt;</button>
        </div>
      </div>

      <div className="overflow-auto rounded-2xl border border-white/10">
        <table className="w-full text-sm min-w-[900px]">
          <thead className="bg-white/5">
            <tr className="text-left">
              <th className="p-3">S/N</th>
              <th className="p-3">Merchant</th>
              <th className="p-3">Sender UPI ID</th>
              <th className="p-3">Receiver UPI ID</th>
              <th className="p-3">UTR</th>
              <th className="p-3">Actions</th>
            </tr>
          </thead>
          <tbody>
            {items.length === 0 && !loading && (
              <tr><td colSpan={6} className="p-6 text-center text-neutral-400">No records</td></tr>
            )}
            {items.map((t, idx) => (
              <tr key={t.id} className="border-t border-white/5">
                <td className="p-3">{offset + idx + 1}</td>
                <td className="p-3">{t.merchant_name}</td>
                <td className="p-3 font-mono">{t.sender_upi_id}</td>
                <td className="p-3 font-mono">{t.receiver_upi_id}</td>
                <td className="p-3 font-mono">{t.utr || <span className="text-neutral-500">(empty)</span>}</td>
                <td className="p-3">
                  <div className="flex gap-2">
                    <button onClick={()=>act(t.id, "approve")} className="px-2 py-1 rounded-lg bg-emerald-500/15 hover:bg-emerald-500/25 border border-emerald-500/30">Approve</button>
                    <button onClick={()=>act(t.id, "decline")} className="px-2 py-1 rounded-lg bg-rose-500/15 hover:bg-rose-500/25 border border-rose-500/30">Decline</button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      {loading && <div className="text-sm text-neutral-400">Loading…</div>}
      {err && <div className="text-sm text-rose-400">{err}</div>}
    </div>
  );
}

export default function App(){
  const { route, push } = useHashRoute();
  const [user, setUser] = useState(null);
  const isAuthed = !!user;

  useEffect(() => {
    const token = localStorage.getItem("moshano_token");
    if (!token) return;
    apiFetch("/me").then((u)=>{
      setUser(u);
      if (route === "/login") push("/dashboard");
    }).catch(()=> localStorage.removeItem("moshano_token"));
  }, []);

  const logout = () => { localStorage.removeItem("moshano_token"); setUser(null); location.hash = "/login"; };

  if (!isAuthed) return <LoginPage onLogin={(u)=> setUser(u)} />;

  return (
    <Shell user={user} onLogout={logout}>
      {route === "/dashboard" && <DashboardHome />}
      {route === "/transactions" && <TransactionsPage />}
      {route !== "/dashboard" && route !== "/transactions" && (
        <div className="text-neutral-400">Not found</div>
      )}
    </Shell>
  );
}
