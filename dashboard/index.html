<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Moshano Admin</title>
<link rel="icon" href="/favicon.svg" type="image/svg+xml" />
<!-- Tailwind via CDN (no build needed) -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- In-browser React (no build needed) -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
</head>
<body class="bg-neutral-950 text-neutral-100">
<div id="app"></div>

<script type="text/javascript">
/** CONFIG **/
const API_BASE = "https://moshano-api.shanoof.workers.dev/api"; // ← change if needed

/** API helper **/
function apiFetch(path, opts = {}) {
  const token = localStorage.getItem("moshano_token");
  const headers = {
    "Content-Type": "application/json",
    ...(token ? { Authorization: `Bearer ${token}` } : {}),
    ...(opts.headers || {}),
  };
  return fetch(`${API_BASE}${path}`, { ...opts, headers })
    .then(async (r) => {
      if (!r.ok) throw new Error((await r.text()) || r.statusText);
      const ct = r.headers.get("content-type") || "";
      return ct.includes("application/json") ? r.json() : r.text();
    });
}

/** Tiny hash router **/
function useHashRoute(React) {
  const { useEffect, useState } = React;
  const [route, setRoute] = useState(() => location.hash.slice(1) || "/login");
  useEffect(() => {
    const onHash = () => setRoute(location.hash.slice(1) || "/login");
    addEventListener("hashchange", onHash);
    return () => removeEventListener("hashchange", onHash);
  }, []);
  const push = (path) => (location.hash = path);
  return { route, push };
}

/** Components **/
function Shell({ user, onLogout, children }) {
  return (
    React.createElement("div", null,
      React.createElement("header", { className: "border-b border-white/10 sticky top-0 backdrop-blur bg-black/40 z-40" },
        React.createElement("div", { className: "max-w-6xl mx-auto px-4 h-14 flex items-center justify-between" },
          React.createElement("div", { className: "flex items-center gap-3" },
            React.createElement("img", { src: "/assets/img/logo.png", alt: "Moshano", className: "w-7 h-7 rounded" }),
            React.createElement("span", { className: "font-semibold tracking-tight" }, "Moshano Admin"),
            React.createElement("nav", { className: "ml-6 hidden sm:flex items-center gap-1 text-sm" },
              React.createElement("a", { href: "#/dashboard", className: "px-2 py-1 rounded hover:bg-white/5" }, "Dashboard"),
              React.createElement("a", { href: "#/transactions", className: "px-2 py-1 rounded hover:bg-white/5" }, "Transactions")
            )
          ),
          React.createElement("div", { className: "flex items-center gap-3 text-sm" },
            React.createElement("span", { className: "text-neutral-400" }, "Signed in as"),
            React.createElement("span", { className: "font-medium" }, user?.name || "—"),
            React.createElement("button", { onClick: onLogout, className: "px-2 py-1 rounded bg-white/10 hover:bg-white/15" }, "Logout")
          )
        )
      ),
      React.createElement("main", { className: "max-w-6xl mx-auto px-4 py-6" }, children),
      React.createElement("footer", { className: "border-t border-white/10 text-xs text-neutral-400" },
        React.createElement("div", { className: "max-w-6xl mx-auto px-4 py-4" }, `© ${new Date().getFullYear()} moshano technologies`)
      )
    )
  );
}

function Stat({ label, value, hint }) {
  return (
    React.createElement("div", { className: "rounded-2xl border border-white/10 bg-white/5 p-4" },
      React.createElement("div", { className: "text-xs uppercase tracking-wider text-neutral-400" }, label),
      React.createElement("div", { className: "text-2xl font-semibold mt-1" }, value),
      hint ? React.createElement("div", { className: "text-xs text-neutral-500 mt-1" }, hint) : null
    )
  );
}

function LoginPage({ onLogin }) {
  const React_ = React;
  const { useState } = React_;
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState("");

	async function submit(e){
	  e.preventDefault();
	  if (loading) return;
	  setErr("");
	  setLoading(true);

	  try {
		const payload = { email: email.trim(), password };
		const { token, user } = await apiFetch("/login", {
		  method: "POST",
		  body: JSON.stringify(payload)
		});

		// 1) Save token
		localStorage.setItem("moshano_token", token);

		// 2) Fetch the actual logged-in user profile
		let me = null;
		try {
		  me = await apiFetch("/me"); // requires your backend /me to return the real user
		} catch { /* ignore */ }

		// 3) Pick the best available user object
		const effectiveUser = (me && (me.name || me.email)) ? me : user;

		// 4) Persist user + update UI
		localStorage.setItem("moshano_user", JSON.stringify(effectiveUser));
		onLogin(effectiveUser);

		location.hash = "/dashboard";
	  } catch (err) {
		const msg = String(err?.message || err);
		setErr(
		  msg.includes("401") || msg.toLowerCase().includes("bad creds")
			? "Incorrect email or password"
			: `Login failed: ${msg}`
		);
	  } finally {
		setLoading(false);
	  }
	}


  return (
    React.createElement("div", { className: "min-h-screen grid place-items-center px-4" },
      React.createElement("div", { className: "w-full max-w-md border border-white/10 rounded-3xl p-6 bg-white/5 backdrop-blur" },
        React.createElement("div", { className: "flex items-center gap-3 mb-4" },
          React.createElement("img", { src: "/assets/img/logo.png", alt: "Moshano", className: "w-8 h-8" }),
          React.createElement("h1", { className: "text-xl font-semibold" }, "Moshano Admin")
        ),
        React.createElement("p", { className: "text-sm text-neutral-400 mb-4" }, "Sign in to manage payments."),
        React.createElement("form", { onSubmit: submit, className: "space-y-3" },
          React.createElement("div", null,
            React.createElement("label", { className: "block text-sm mb-1" }, "Email"),
            React.createElement("input", {
              required: true, type: "email", value: email, onChange: (e)=>setEmail(e.target.value),
              className: "w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-white/20"
            })
          ),
          React.createElement("div", null,
            React.createElement("label", { className: "block text-sm mb-1" }, "Password"),
            React.createElement("input", {
              required: true, type: "password", value: password, onChange: (e)=>setPassword(e.target.value),
              className: "w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-white/20"
            })
          ),
          err ? React.createElement("div", { className: "text-red-400 text-sm" }, err) : null,
          React.createElement("button", { disabled: loading, className: "w-full py-2 rounded-xl bg-gradient-to-r from-cyan-400 to-fuchsia-500 font-semibold disabled:opacity-60" },
            loading ? "Signing in…" : "Sign in"
          )
        )
      )
    )
  );
}

function DashboardHome() {
  const React_ = React; const { useEffect, useState } = React_;
  const [stats, setStats] = useState({ total: 0, approved: 0, pending: 0, declined: 0 });
  useEffect(() => { apiFetch("/stats").then(setStats).catch(()=>{}); }, []);
  return (
    React.createElement("div", { className: "grid sm:grid-cols-2 lg:grid-cols-4 gap-4" },
      React.createElement(Stat, { label: "Total Txns", value: stats.total }),
      React.createElement(Stat, { label: "Approved", value: stats.approved }),
      React.createElement(Stat, { label: "Pending", value: stats.pending }),
      React.createElement(Stat, { label: "Declined", value: stats.declined }),
    )
  );
}

<script type="text/javascript">
function TransactionsPage(){
  const React_ = React; const { useEffect, useState } = React_;
  const [items, setItems] = useState([]);
  const [page, setPage] = useState(0);
  const [auto, setAuto] = useState(true);
  const [hideEmptyUtr, setHideEmptyUtr] = useState(false);
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState("");

  const limit = 50;
  const offset = page * limit;

  // INR formatter (expects rupees)
  const fmtINR = (rupees) =>
    new Intl.NumberFormat("en-IN", { style: "currency", currency: "INR", maximumFractionDigits: 2 }).format(rupees || 0);

  // Convert row to rupees regardless of server field
  const toRupees = (t) => {
    if (typeof t.amount_paise === "number") return t.amount_paise / 100; // integer paise → rupees
    if (typeof t.amount === "number") return t.amount;                   // already rupees
    return 0;
  };

  const load = async () => {
    setLoading(true); setErr("");
    try{
      const q = new URLSearchParams({ limit: String(limit), offset: String(offset), hideEmptyUtr: String(hideEmptyUtr) });
      const res = await apiFetch(`/transactions?${q.toString()}`);
      setItems(res.rows || []);
    }catch(e){ setErr(e.message || "Failed to load"); }
    finally{ setLoading(false); }
  };

  useEffect(() => { load(); }, [page, hideEmptyUtr]);
  useEffect(() => { if (!auto) return; const id = setInterval(load, 30000); return () => clearInterval(id); }, [auto, page, hideEmptyUtr]);

  async function act(id, action){
    const ok = confirm(`Are you sure you want to ${action} txn ${id}?`);
    if (!ok) return;
    try{
      await apiFetch(`/transactions/${id}/${action}`, { method: "POST" });
      await load();
    }catch(e){ alert(e.message || "Action failed"); }
  }

  return (
    React.createElement("div", { className: "space-y-3" },
      React.createElement("div", { className: "flex flex-wrap items-center justify-between gap-3" },
        React.createElement("div", { className: "flex items-center gap-3" },
          React.createElement("label", { className: "flex items-center gap-2 text-sm" },
            React.createElement("input", { type: "checkbox", checked: auto, onChange: (e)=>setAuto(e.target.checked) }),
            "Auto-refresh (30s)"),
          React.createElement("label", { className: "flex items-center gap-2 text-sm" },
            React.createElement("input", { type: "checkbox", checked: hideEmptyUtr, onChange: (e)=>setHideEmptyUtr(e.target.checked) }),
            "Hide Empty UTR")
        ),
        React.createElement("div", { className: "flex items-center gap-2" },
          React.createElement("button", { onClick: load, className: "px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/15 text-sm" }, "Refresh"),
          React.createElement("div", { className: "text-sm text-neutral-400" }, `Page ${page + 1}`),
          React.createElement("button", { onClick: ()=>setPage((p)=>Math.max(0,p-1)), className: "px-2 py-1.5 rounded-lg bg-white/10 disabled:opacity-50", disabled: page===0 }, "<"),
          React.createElement("button", { onClick: ()=>setPage((p)=>p+1), className: "px-2 py-1.5 rounded-lg bg-white/10" }, ">")
        )
      ),

      React.createElement("div", { className: "overflow-auto rounded-2xl border border-white/10" },
        React.createElement("table", { className: "w-full text-sm min-w-[1100px]" },
          React.createElement("thead", { className: "bg-white/5" },
            React.createElement("tr", { className: "text-left" },
              React.createElement("th", { className: "p-3" }, "S/N"),
              React.createElement("th", { className: "p-3" }, "Merchant"),
              React.createElement("th", { className: "p-3" }, "Sender UPI ID"),
              React.createElement("th", { className: "p-3" }, "Receiver UPI ID"),
              React.createElement("th", { className: "p-3" }, "UTR"),
              React.createElement("th", { className: "p-3" }, "Amount"),
              React.createElement("th", { className: "p-3" }, "Status"),
              React.createElement("th", { className: "p-3" }, "Actions")
            )
          ),
          React.createElement("tbody", null,
            (items.length === 0 && !loading) ?
              React.createElement("tr", null, React.createElement("td", { colSpan: 8, className: "p-6 text-center text-neutral-400" }, "No records")) :
              items.map((t, idx) => {
                const status = (t.status || "pending").toLowerCase();
                const statusColor =
                  status === "approved" ? "text-emerald-400" :
                  status === "declined" ? "text-rose-400" :
                  "text-sky-400";
                const disabled = status === "approved" || status === "declined";
                const rupees = toRupees(t);

                return React.createElement("tr", { key: t.id, className: "border-t border-white/5" },
                  React.createElement("td", { className: "p-3" }, offset + idx + 1),
                  React.createElement("td", { className: "p-3" }, t.merchant_name),
                  React.createElement("td", { className: "p-3 font-mono" }, t.sender_upi_id),
                  React.createElement("td", { className: "p-3 font-mono" }, t.receiver_upi_id),
                  React.createElement("td", { className: "p-3 font-mono" }, t.utr || React.createElement("span", { className: "text-neutral-500" }, "(empty)")),
                  React.createElement("td", { className: "p-3 font-mono text-right" }, fmtINR(rupees)),
                  React.createElement("td", { className: `p-3 font-medium ${statusColor}` },
                    status.charAt(0).toUpperCase() + status.slice(1)
                  ),
                  React.createElement("td", { className: "p-3" },
                    React.createElement("div", { className: "flex gap-2" },
                      React.createElement("button", {
                        onClick: ()=>act(t.id, "approve"),
                        disabled,
                        className:
                          "px-2 py-1 rounded-lg border " +
                          (disabled
                            ? "opacity-40 cursor-not-allowed"
                            : "bg-emerald-500/15 hover:bg-emerald-500/25 border-emerald-500/30")
                      }, "Approve"),
                      React.createElement("button", {
                        onClick: ()=>act(t.id, "decline"),
                        disabled,
                        className:
                          "px-2 py-1 rounded-lg border " +
                          (disabled
                            ? "opacity-40 cursor-not-allowed"
                            : "bg-rose-500/15 hover:bg-rose-500/25 border-rose-500/30")
                      }, "Decline")
                    )
                  )
                );
              })
          )
        )
      ),
      loading ? React.createElement("div", { className: "text-sm text-neutral-400" }, "Loading…") : null,
      err ? React.createElement("div", { className: "text-sm text-rose-400" }, err) : null
    )
  );
}
</script>



function App(){
  const { route, push } = useHashRoute(React);
  const { useEffect, useState } = React;
  const [user, setUser] = useState(null);

  useEffect(() => {
    const token = localStorage.getItem("moshano_token");
    if (!token) return;
    apiFetch("/me").then((u)=>{
      setUser(u);
      if (route === "/login") push("/dashboard");
    }).catch(()=> localStorage.removeItem("moshano_token"));
  }, []);

  const logout = () => { localStorage.removeItem("moshano_token"); setUser(null); location.hash = "/login"; };

  if (!user) return React.createElement(LoginPage, { onLogin: (u)=> setUser(u) });

  return React.createElement(Shell, { user, onLogout: logout },
    route === "/dashboard" ? React.createElement(DashboardHome) :
    route === "/transactions" ? React.createElement(TransactionsPage) :
    React.createElement("div", { className: "text-neutral-400" }, "Not found")
  );
}

// Mount
ReactDOM.createRoot(document.getElementById("app")).render(React.createElement(App));
</script>
</body>
</html>
